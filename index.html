<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新規事業ボードゲーム 計算アプリ (プロトタイプ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f0f2f5;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
        }
        .tab-button.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 700;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
        }
        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
         .btn-danger:hover {
            background-color: #dc2626;
        }
        .btn-toggle-group .btn {
            background-color: #e5e7eb;
            color: #4b5563;
            border-color: #d1d5db;
        }
        .btn-toggle-group .btn.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .table-header {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- メインコンテナ -->
    <div id="app" class="container mx-auto p-4 md:p-6 max-w-4xl">

        <!-- ヘッダー (スマホ対応) -->
        <header class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800 text-center md:text-left">新規事業ボードゲーム 計算アプリ</h1>
                <p id="turn-display" class="text-lg text-gray-600 font-semibold text-center md:text-left"></p>
            </div>
            <div class="flex gap-4 justify-center md:justify-end">
                <button id="settings-btn" class="btn bg-gray-500 text-white hover:bg-gray-600 shadow-md">設定</button>
                <button id="reset-game-btn" class="btn btn-danger hover:bg-red-600 shadow-md">ゲームリセット</button>
            </div>
        </header>

        <!-- ダッシュボード -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="card p-4 text-center">
                <h2 class="text-sm font-semibold text-gray-500">現金残高</h2>
                <p id="cash-balance" class="text-3xl font-bold"></p>
            </div>
            <div class="card p-4 text-center">
                <h2 class="text-sm font-semibold text-gray-500">今期の純利益</h2>
                <p id="current-period-profit" class="text-3xl font-bold"></p>
            </div>
            <div class="card p-4 text-center">
                <h2 class="text-sm font-semibold text-gray-500">総資産</h2>
                <p id="total-assets" class="text-3xl font-bold"></p>
            </div>
        </section>

        <!-- アクションボタン (スマホ対応) -->
        <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <button id="add-transaction-btn" class="btn btn-primary py-3 shadow-md">収入/支出</button>
            <button id="manage-employees-btn" class="btn btn-secondary py-3 shadow-md">人材管理</button>
            <button id="manage-business-btn" class="btn btn-secondary py-3 shadow-md">事業管理</button>
            <button id="manage-debt-btn" class="btn btn-secondary py-3 shadow-md">借入/返済</button>
            <button id="next-turn-btn" class="bg-green-500 text-white font-bold col-span-full py-3 rounded-lg shadow-xl hover:bg-green-600 transition-colors text-lg">ターン終了</button>
        </section>

        <!-- 財務諸表 -->
        <section class="card p-4 md:p-6">
            <div class="border-b border-gray-200 mb-4">
                <nav class="flex space-x-2 md:space-x-4" id="report-tabs">
                    <button data-tab="pl" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors active">損益計算書 (PL)</button>
                    <button data-tab="bs" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">貸借対照表 (BS)</button>
                    <button data-tab="cs" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">キャッシュフロー (CS)</button>
                </nav>
            </div>
            <!-- UI改善: プルダウンをボタングループに変更 -->
            <div id="period-selector" class="btn-toggle-group flex justify-center md:justify-end mb-4">
                <button data-period="lastTurn" id="last-turn-btn" class="btn rounded-r-none">先月</button>
                <button data-period="currentTurn" class="btn rounded-none">今月</button>
                <button data-period="currentYear" class="btn rounded-none">今年度</button>
                <button data-period="total" class="btn rounded-l-none active">通算</button>
            </div>

            <!-- ★修正: メイン グラフコンテナ -->
            <div id="chart-container" class="mb-4 h-64 relative">
                <canvas id="main-chart"></canvas>
            </div>

            <div id="report-content" class="overflow-x-auto">
                <!-- 財務諸表テーブルがここに挿入されます -->
            </div>
        </section>
    </div>

    <!-- モーダル: 収入・支出の記録 (UI改善) -->
    <div id="transaction-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">収入・支出の記録</h2>
            <form id="transaction-form">
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">種類</label>
                    <div id="transaction-type-selector" class="btn-toggle-group flex">
                        <button type="button" data-type="expense" class="btn w-1/2 rounded-r-none active">支出</button>
                        <button type="button" data-type="income" class="btn w-1/2 rounded-l-none">収入</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">カテゴリ</label>
                    <div id="transaction-category-selector" class="grid grid-cols-2 gap-2 btn-toggle-group">
                        <!-- カテゴリボタンがここに挿入されます -->
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">金額 (万円)</label>
                    <input type="number" id="transaction-amount" class="w-full p-2 border rounded" placeholder="例: 100" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-transaction" class="btn btn-secondary">キャンセル</button>
                    <button type="submit" class="btn btn-primary">記録する</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- モーダル: 人材管理 (UI改善) -->
    <div id="employees-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">人材管理</h2>
            <div class="mb-4">
                <h3 class="font-semibold mb-2">新規雇用</h3>
                <p class="text-sm text-gray-500 mb-2">雇用したい人材の人件費をタップしてください。</p>
                <div id="hire-options" class="grid grid-cols-2 gap-4">
                     <button data-cost="100" class="btn bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200">100万円/月</button>
                     <button data-cost="150" class="btn bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200">150万円/月</button>
                     <button data-cost="200" class="btn bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200">200万円/月</button>
                     <button data-cost="300" class="btn bg-blue-100 text-blue-800 border-blue-200 hover:bg-blue-200">300万円/月</button>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">雇用中の人材 (合計人件費: <span id="total-personnel-cost"></span>万円/月)</h3>
                <ul id="employee-list" class="space-y-2 max-h-60 overflow-y-auto p-1">
                    <!-- 雇用中の人材リストがここに挿入されます -->
                </ul>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-employees-modal" class="btn btn-secondary">閉じる</button>
            </div>
        </div>
    </div>

    <!-- ★新規追加: 事業管理モーダル -->
    <div id="business-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-lg p-6">
            <h2 class="text-xl font-bold mb-4">事業管理</h2>
            <form id="business-form" class="mb-4 border-b pb-4">
                <h3 class="font-semibold mb-2">新規事業の登録</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                    <input type="text" id="business-name" placeholder="事業名" class="p-2 border rounded col-span-full">
                    <input type="number" id="business-revenue" placeholder="月間売上(万円)" class="p-2 border rounded">
                    <input type="number" id="business-cost" placeholder="月間費用(万円)" class="p-2 border rounded">
                    <button type="submit" class="btn btn-primary">登録</button>
                </div>
            </form>
            <div>
                 <h3 class="font-semibold mb-2">登録済みの事業</h3>
                 <ul id="business-list" class="space-y-2 max-h-60 overflow-y-auto p-1">
                    <!-- 登録済みの事業リストがここに挿入されます -->
                 </ul>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" id="close-business-modal" class="btn btn-secondary">閉じる</button>
            </div>
        </div>
    </div>

    <!-- モーダル: 借入・返済 (UI改善) -->
    <div id="debt-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">借入・返済</h2>
            <div class="mb-4">
                <p class="text-sm text-gray-500">現在の借入残高</p>
                <p id="current-debt" class="text-2xl font-bold"></p>
            </div>
            <form id="debt-form">
                 <div class="mb-4">
                    <label class="block mb-2 font-semibold">操作</label>
                    <div id="debt-action-selector" class="btn-toggle-group flex">
                        <button type="button" data-action="borrow" class="btn w-1/2 rounded-r-none active">借入</button>
                        <button type="button" data-action="repay" class="btn w-1/2 rounded-l-none">返済</button>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block mb-2 font-semibold">金額 (万円)</label>
                    <input type="number" id="debt-amount" class="w-full p-2 border rounded" placeholder="例: 1000" required>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-debt" class="btn btn-secondary">キャンセル</button>
                    <button type="submit" class="btn btn-primary">実行</button>
                </div>
            </form>
        </div>
    </div>

    <!-- モーダル: 設定 -->
    <div id="settings-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-md p-6">
            <h2 class="text-xl font-bold mb-4">ゲーム設定</h2>
            <form id="settings-form">
                <div class="mb-4">
                    <label for="interest-rate-input" class="block mb-2">借入の年利 (%)</label>
                    <input type="number" id="interest-rate-input" class="w-full p-2 border rounded" placeholder="例: 5" step="0.1" required>
                </div>
                <!-- ★新規追加: ゲーム期間設定 -->
                <div class="mb-4">
                    <label for="game-length-input" class="block mb-2">ゲームの長さ (年)</label>
                    <input type="number" id="game-length-input" class="w-full p-2 border rounded" placeholder="例: 3" min="1" max="5" step="1" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-settings" class="btn btn-secondary">キャンセル</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ★新規追加: 確認モーダル -->
    <div id="confirm-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-sm p-6 text-center">
            <p id="confirm-message" class="text-lg mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="confirm-no-btn" class="btn btn-secondary w-24">いいえ</button>
                <button id="confirm-yes-btn" class="btn btn-danger w-24">はい</button>
            </div>
        </div>
    </div>

    <!-- ★新規追加: リザルトモーダル -->
    <div id="results-modal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="card w-full max-w-lg p-8 text-center">
            <h2 class="text-4xl font-bold mb-4 text-yellow-500">ゲーム終了！</h2>
            <h3 class="text-2xl font-semibold mb-6">最終結果</h3>
            <div class="space-y-4 text-left text-lg bg-gray-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between">
                    <span class="font-semibold">累計純利益:</span>
                    <span id="result-profit" class="font-bold"></span>
                </div>
                <div class="flex justify-between border-t pt-4">
                    <span class="font-semibold">事業将来価値ボーナス:</span>
                    <span id="result-bonus" class="font-bold text-green-600"></span>
                </div>
                <div class="flex justify-between text-2xl font-bold border-t-2 pt-4 mt-4 text-blue-600">
                    <span>最終スコア:</span>
                    <span id="result-total-score"></span>
                </div>
            </div>
            <!-- ★追加: リザルト画面の財務諸表タブ -->
            <div class="mt-6">
                 <div class="border-b border-gray-200 mb-4">
                    <nav class="flex space-x-2 md:space-x-4" id="result-report-tabs">
                        <button data-tab="pl" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors active">最終PL</button>
                        <button data-tab="bs" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">最終BS</button>
                        <button data-tab="cs" class="tab-button flex-1 md:flex-initial py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition-colors">最終CS</button>
                    </nav>
                </div>
                <!-- ★追加: リザルト グラフコンテナ -->
                <div id="result-chart-container" class="mb-4 h-64 relative">
                    <canvas id="result-chart"></canvas>
                </div>
                <div id="result-report-content" class="overflow-x-auto text-left max-h-64">
                    <!-- Final financial statements will be rendered here -->
                </div>
            </div>
            <button id="new-game-btn" class="btn btn-primary w-full py-3 text-lg mt-8">新しいゲームを始める</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- 状態管理 (State Management) ---
            let gameState;
            let uiState = {
                transaction: { type: 'expense', category: '' },
                debtAction: 'borrow',
                reportPeriod: 'total'
            };
            let finalFinancials = null; 
            // ★修正: グラフインスタンスを管理
            let chartInstances = {
                main: null,
                result: null
            };

            // --- DOM要素 ---
            const dom = {
                turnDisplay: document.getElementById('turn-display'),
                cashBalance: document.getElementById('cash-balance'),
                currentPeriodProfit: document.getElementById('current-period-profit'),
                totalAssets: document.getElementById('total-assets'),
                reportTabs: document.getElementById('report-tabs'),
                periodSelector: document.getElementById('period-selector'),
                reportContent: document.getElementById('report-content'),
                transactionModal: document.getElementById('transaction-modal'),
                transactionForm: document.getElementById('transaction-form'),
                transactionTypeSelector: document.getElementById('transaction-type-selector'),
                transactionCategorySelector: document.getElementById('transaction-category-selector'),
                transactionAmount: document.getElementById('transaction-amount'),
                employeesModal: document.getElementById('employees-modal'),
                hireOptions: document.getElementById('hire-options'),
                totalPersonnelCost: document.getElementById('total-personnel-cost'),
                employeeList: document.getElementById('employee-list'),
                debtModal: document.getElementById('debt-modal'),
                debtForm: document.getElementById('debt-form'),
                currentDebt: document.getElementById('current-debt'),
                debtActionSelector: document.getElementById('debt-action-selector'),
                debtAmount: document.getElementById('debt-amount'),
                settingsModal: document.getElementById('settings-modal'),
                settingsForm: document.getElementById('settings-form'),
                interestRateInput: document.getElementById('interest-rate-input'),
                confirmModal: document.getElementById('confirm-modal'),
                confirmMessage: document.getElementById('confirm-message'),
                confirmYesBtn: document.getElementById('confirm-yes-btn'),
                confirmNoBtn: document.getElementById('confirm-no-btn'),
                businessModal: document.getElementById('business-modal'),
                businessForm: document.getElementById('business-form'),
                businessList: document.getElementById('business-list'),
                gameLengthInput: document.getElementById('game-length-input'),
                resultsModal: document.getElementById('results-modal'),
                resultProfit: document.getElementById('result-profit'),
                resultBonus: document.getElementById('result-bonus'),
                resultTotalScore: document.getElementById('result-total-score'),
                resultReportTabs: document.getElementById('result-report-tabs'),
                resultReportContent: document.getElementById('result-report-content'),
                // ★修正: グラフDOM
                mainChart: document.getElementById('main-chart'),
                resultChart: document.getElementById('result-chart'),
            };

            // --- 定数 ---
            const CONSTANTS = {
                INITIAL_CASH: 5000, 
                MONTHLY_SUPPORT: 500, 
                DEFAULT_INTEREST_RATE: 0.05, 
                RETIREMENT_COST_MULTIPLIER: 3, 
                DEFAULT_TOTAL_TURNS: 36,
            };
            
            const CATEGORIES = {
                income: [
                    { value: 'external_investment', text: '外部投資'},
                    { value: 'misc_income', text: '雑費収入'}
                ],
                expense: [
                    { value: 'hypothesis_testing', text: '仮説検証費用'},
                    { value: 'business_construction', text: '事業構築費用'},
                    { value: 'misc_expense', text: '雑費支出'}
                ]
            };


            // --- ゲームの初期化 ---
            function initGame() {
                const savedState = localStorage.getItem('boardGameCalcState');
                if (savedState) {
                    gameState = JSON.parse(savedState);
                    if (typeof gameState.interestRate === 'undefined') gameState.interestRate = CONSTANTS.DEFAULT_INTEREST_RATE;
                    if (typeof gameState.totalTurns === 'undefined') gameState.totalTurns = CONSTANTS.DEFAULT_TOTAL_TURNS;
                    if (typeof gameState.businesses === 'undefined') gameState.businesses = [];
                } else {
                    createNewGame();
                }
                updatePeriodSelectorUI();
                renderAll();
                 if (gameState.currentTurn > gameState.totalTurns) {
                    showResults();
                }
            }
            
            function createNewGame() {
                gameState = {
                    currentTurn: 1,
                    cash: CONSTANTS.INITIAL_CASH,
                    employees: [],
                    businesses: [],
                    transactions: [],
                    debt: 0,
                    interestRate: CONSTANTS.DEFAULT_INTEREST_RATE,
                    totalTurns: CONSTANTS.DEFAULT_TOTAL_TURNS,
                };
            }
            
            async function resetGame() {
                const confirmed = await showConfirmation(
                    '本当にゲームをリセットしますか？全てのデータが削除されます。',
                    { danger: true }
                );
                if(confirmed) {
                    createNewGame();
                    saveGame();
                    renderAll();
                }
            }

            function saveGame() {
                localStorage.setItem('boardGameCalcState', JSON.stringify(gameState));
            }

            // --- 描画関連 ---
            function renderAll() {
                renderDashboard();
                renderReport();
                renderEmployeeList();
                renderBusinessList();
            }

            function renderDashboard() {
                const year = Math.floor((gameState.currentTurn - 1) / 12) + 1;
                const month = ((gameState.currentTurn - 1) % 12) + 1;
                dom.turnDisplay.textContent = ` ${year}年目 ${month}月 (${gameState.currentTurn > gameState.totalTurns ? gameState.totalTurns : gameState.currentTurn}/${gameState.totalTurns})`;
                
                const formatYen = (val) => `${val.toLocaleString()}万円`;
                const { pl, bs } = calculateFinancials('currentYear');
                
                dom.cashBalance.textContent = formatYen(gameState.cash);
                dom.currentPeriodProfit.textContent = formatYen(pl.profit);
                dom.totalAssets.textContent = formatYen(bs.totalAssets);

                const lastTurnBtn = document.getElementById('last-turn-btn');
                if (lastTurnBtn) {
                    if (gameState.currentTurn <= 1) {
                        lastTurnBtn.disabled = true;
                        lastTurnBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        if (uiState.reportPeriod === 'lastTurn') {
                            uiState.reportPeriod = 'currentTurn';
                            updatePeriodSelectorUI();
                            renderReport();
                        }
                    } else {
                        lastTurnBtn.disabled = false;
                        lastTurnBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
            }
            
            // ★修正: グラフとテーブルを描画
            function renderReport() {
                const activeTab = dom.reportTabs.querySelector('.active').dataset.tab;
                const period = uiState.reportPeriod;
                
                // 1. 常にスナップショットデータを取得 (テーブル用)
                const { pl, bs, cs } = calculateFinancials(period);
                
                // 2. テーブルHTMLを生成
                let html = '';
                if (activeTab === 'pl') html = generatePLHtml(pl);
                else if (activeTab === 'bs') html = generateBSHtml(bs);
                else if (activeTab === 'cs') html = generateCSHtml(cs);
                dom.reportContent.innerHTML = html;

                // 3. グラフを描画
                if (chartInstances.main) {
                    chartInstances.main.destroy();
                    chartInstances.main = null;
                }

                const ctx = dom.mainChart.getContext('2d');
                
                if (period === 'lastTurn' || period === 'currentTurn') {
                    // --- スナップショット・グラフ ---
                    if (activeTab === 'pl') {
                        chartInstances.main = createPLChart(ctx, pl);
                    } else if (activeTab === 'bs') {
                        chartInstances.main = createBSChart(ctx, bs);
                    } else if (activeTab === 'cs') {
                        chartInstances.main = createCSChart(ctx, cs);
                    }
                } else {
                    // --- 時系列グラフ ---
                    const timeSeriesData = generateTimeSeriesData(period);
                    if (activeTab === 'pl') {
                        chartInstances.main = createPLTimeSeriesChart(ctx, timeSeriesData);
                    } else if (activeTab === 'bs') {
                        chartInstances.main = createBSTimeSeriesChart(ctx, timeSeriesData);
                    } else if (activeTab === 'cs') {
                        chartInstances.main = createCSTimeSeriesChart(ctx, timeSeriesData);
                    }
                }
            }
            
            function generatePLHtml(pl) {
                const format = (val) => (val !== 0 ? val.toLocaleString() : '-');
                return `
                    <table class="w-full text-left text-sm md:text-base">
                        <thead class="table-header">
                            <tr><th class="p-1 md:p-2 font-semibold" colspan="2">損益計算書 (PL)</th></tr>
                        </thead>
                        <tbody>
                            <tr class="border-b"><td class="p-1 md:p-2 font-semibold text-blue-600" colspan="2">収益</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業からの収入</td><td class="p-1 md:p-2 text-right">${format(pl.businessIncome)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">雑費収入</td><td class="p-1 md:p-2 text-right">${format(pl.miscIncome)}</td></tr>
                            <tr class="border-b font-bold"><td class="p-1 md:p-2">収益合計</td><td class="p-1 md:p-2 text-right">${format(pl.totalRevenue)}</td></tr>

                            <tr class="border-b"><td class="p-1 md:p-2 font-semibold text-red-600" colspan="2">費用</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業費用</td><td class="p-1 md:p-2 text-right">${format(pl.businessCost)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">人件費</td><td class="p-1 md:p-2 text-right">${format(pl.personnelCost)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">退職金</td><td class="p-1 md:p-2 text-right">${format(pl.retirementCost)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">仮説検証費用</td><td class="p-1 md:p-2 text-right">${format(pl.hypothesisCost)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業構築費用</td><td class="p-1 md:p-2 text-right">${format(pl.constructionCost)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">支払利息</td><td class="p-1 md:p-2 text-right">${format(pl.interestExpense)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">雑費支出</td><td class="p-1 md:p-2 text-right">${format(pl.miscExpense)}</td></tr>
                            <tr class="border-b font-bold"><td class="p-1 md:p-2">費用合計</td><td class="p-1 md:p-2 text-right">${format(pl.totalExpense)}</td></tr>

                            <tr class="font-bold text-lg ${pl.profit >= 0 ? 'bg-blue-100' : 'bg-red-100'}"><td class="p-2">純利益</td><td class="p-2 text-right">${pl.profit.toLocaleString()}</td></tr>
                        </tbody>
                    </table>
                `;
            }

            function generateBSHtml(bs) {
                const format = (val) => (val !== 0 ? val.toLocaleString() : '-');
                return `
                    <table class="w-full text-left text-sm md:text-base">
                        <thead class="table-header">
                            <tr><th class="p-1 md:p-2 font-semibold" colspan="2">貸借対照表 (BS)</th></tr>
                        </thead>
                        <tbody>
                            <tr class="table-header"><td class="p-1 md:p-2 font-semibold" colspan="2">資産の部</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">現金</td><td class="p-1 md:p-2 text-right">${format(bs.cash)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業投資額</td><td class="p-1 md:p-2 text-right">${format(bs.investmentValue)}</td></tr>
                            <tr class="border-b font-bold bg-gray-50"><td class="p-1 md:p-2">資産合計</td><td class="p-1 md:p-2 text-right">${bs.totalAssets.toLocaleString()}</td></tr>
                        </tbody>
                        <tbody class="mt-4">
                            <tr class="table-header"><td class="p-1 md:p-2 font-semibold" colspan="2">負債・純資産の部</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">借入金 (負債)</td><td class="p-1 md:p-2 text-right">${format(bs.debt)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">外部からの投資額 (純資産)</td><td class="p-1 md:p-2 text-right">${format(bs.externalInvestment)}</td></tr>
                            <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">利益剰余金 (純資産)</td><td class="p-1 md:p-2 text-right">${format(bs.retainedEarnings)}</td></tr>
                            <tr class="border-b font-bold bg-gray-50"><td class="p-1 md:p-2">負債・純資産合計</td><td class="p-1 md:p-2 text-right">${bs.totalLiabilitiesAndNetAssets.toLocaleString()}</td></tr>
                        </tbody>
                    </table>
                `;
            }

            function generateCSHtml(cs) {
                const format = (val) => (val !== 0 ? val.toLocaleString() : '-');
                return `
                    <table class="w-full text-left text-sm md:text-base">
                        <thead class="table-header">
                            <tr><th class="p-1 md:p-2 font-semibold" colspan="2">キャッシュフロー計算書 (CS)</th></tr>
                        </thead>
                        <tbody>
                             <tr class="border-b"><td class="p-1 md:p-2 font-semibold">営業活動によるCF</td><td class="p-1 md:p-2 text-right font-semibold">${format(cs.operatingCF)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業収入</td><td class="p-1 md:p-2 text-right text-green-600">+${format(cs.operating.businessIncome)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">雑費収入</td><td class="p-1 md:p-2 text-right text-green-600">+${format(cs.operating.miscIncome)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業費用</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.operating.businessCost)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">人件費</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.operating.personnelCost)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">退職金</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.operating.retirementCost)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">支払利息</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.operating.interestExpense)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">雑費支出</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.operating.miscExpense)}</td></tr>

                             <tr class="border-b"><td class="p-1 md:p-2 font-semibold">投資活動によるCF</td><td class="p-1 md:p-2 text-right font-semibold">${format(cs.investingCF)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">仮説検証費用</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.investing.hypothesisCost)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">事業構築費用</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.investing.constructionCost)}</td></tr>
                             
                             <tr class="border-b"><td class="p-1 md:p-2 font-semibold">財務活動によるCF</td><td class="p-1 md:p-2 text-right font-semibold">${format(cs.financingCF)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">会社からの支援</td><td class="p-1 md:p-2 text-right text-green-600">+${format(cs.financing.support)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">外部投資</td><td class="p-1 md:p-2 text-right text-green-600">+${format(cs.financing.externalInvestment)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">借入</td><td class="p-1 md:p-2 text-right text-green-600">+${format(cs.financing.borrowing)}</td></tr>
                             <tr class="border-b"><td class="p-1 md:p-2 pl-4 md:pl-6">返済</td><td class="p-1 md:p-2 text-right text-red-600">-${format(cs.financing.repayment)}</td></tr>

                            <tr class="font-bold text-lg bg-gray-100"><td class="p-2">現金増減額</td><td class="p-2 text-right">${cs.netCashFlow.toLocaleString()}</td></tr>
                        </tbody>
                    </table>
                `;
            }
            
            function renderEmployeeList() {
                dom.employeeList.innerHTML = '';
                const totalCost = gameState.employees.reduce((sum, e) => sum + e.cost, 0);
                dom.totalPersonnelCost.textContent = totalCost;

                if (gameState.employees.length === 0) {
                    dom.employeeList.innerHTML = '<li class="text-gray-500 text-center p-4">現在、雇用中の人材はいません。</li>';
                    return;
                }

                gameState.employees.forEach(employee => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    li.innerHTML = `
                        <span>人件費: ${employee.cost}万円/月</span>
                        <button data-id="${employee.id}" class="fire-btn btn btn-danger btn-sm py-1 px-2 text-xs">退職</button>
                    `;
                    dom.employeeList.appendChild(li);
                });
            }

            function renderBusinessList() {
                dom.businessList.innerHTML = '';
                 if (gameState.businesses.length === 0) {
                    dom.businessList.innerHTML = '<li class="text-gray-500 text-center p-4">現在、登録済みの事業はありません。</li>';
                    return;
                }
                gameState.businesses.forEach(biz => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-100 p-2 rounded';
                    li.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold">${biz.name}</p>
                            <p class="text-sm text-green-600">売上: ${biz.revenue}万/月</p>
                            <p class="text-sm text-red-600">費用: ${biz.cost}万/月</p>
                        </div>
                        <button data-id="${biz.id}" class="delete-business-btn btn btn-danger btn-sm py-1 px-2 text-xs">削除</button>
                    `;
                    dom.businessList.appendChild(li);
                });
            }

            // --- ★修正: スナップショット・グラフ描画関数 ---
            function createPLChart(ctx, plData) {
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['収益合計', '費用合計', '純利益'],
                        datasets: [{
                            label: '金額 (万円)',
                            data: [plData.totalRevenue, plData.totalExpense, plData.profit],
                            backgroundColor: [ 'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)',
                                plData.profit >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 26, 104, 0.6)' ],
                            borderColor: [ 'rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)',
                                plData.profit >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 26, 104, 1)' ],
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            function createBSChart(ctx, bsData) {
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['資産', '負債・純資産'],
                        datasets: [
                            { label: '現金', data: [bsData.cash, 0], backgroundColor: 'rgba(54, 162, 235, 0.6)' },
                            { label: '事業投資額', data: [bsData.investmentValue, 0], backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                            { label: '借入金', data: [0, bsData.debt], backgroundColor: 'rgba(255, 99, 132, 0.6)' },
                            { label: '外部投資', data: [0, bsData.externalInvestment], backgroundColor: 'rgba(255, 206, 86, 0.6)' },
                            { label: '利益剰余金', data: [0, bsData.retainedEarnings], backgroundColor: 'rgba(153, 102, 255, 0.6)' }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }
                });
            }

            function createCSChart(ctx, csData) {
                const data = [csData.operatingCF, csData.investingCF, csData.financingCF, csData.netCashFlow];
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['営業CF', '投資CF', '財務CF', '現金増減額'],
                        datasets: [{
                            label: '金額 (万円)',
                            data: data,
                            backgroundColor: data.map(v => v >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                            borderColor: data.map(v => v >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }

            // --- ★新規追加: 時系列グラフ描画関数 ---
            function createPLTimeSeriesChart(ctx, timeSeriesData) {
                return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeSeriesData.labels,
                        datasets: [{
                            label: '累計純利益',
                            data: timeSeriesData.cumulativeProfit,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
                });
            }

            function createBSTimeSeriesChart(ctx, timeSeriesData) {
                 return new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: timeSeriesData.labels,
                        datasets: [
                            {
                                label: '総資産',
                                data: timeSeriesData.totalAssets,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                fill: false,
                                tension: 0.1
                            },
                            {
                                label: '現金残高',
                                data: timeSeriesData.cashBalance,
                                borderColor: 'rgba(255, 206, 86, 1)',
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                fill: false,
                                tension: 0.1
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
                });
            }

            function createCSTimeSeriesChart(ctx, timeSeriesData) {
                return new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: timeSeriesData.labels,
                        datasets: [
                            {
                                label: '営業CF',
                                data: timeSeriesData.monthlyOperatingCF,
                                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            },
                            {
                                label: '投資CF',
                                data: timeSeriesData.monthlyInvestingCF,
                                backgroundColor: 'rgba(255, 159, 64, 0.6)',
                            },
                            {
                                label: '財務CF',
                                data: timeSeriesData.monthlyFinancingCF,
                                backgroundColor: 'rgba(153, 102, 255, 0.6)',
                            }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true } }, scales: { x: { stacked: true }, y: { stacked: true } } }
                });
            }


            // --- ★新規追加: 時系列データ生成ロジック ---
            function generateTimeSeriesData(period) {
                let startTurn = 1;
                let endTurn = gameState.currentTurn;

                if (period === 'currentYear') {
                    const currentYear = Math.floor((gameState.currentTurn - 1) / 12);
                    startTurn = currentYear * 12 + 1;
                }
                
                const labels = [];
                const cumulativeProfit = [];
                const cashBalance = [];
                const totalAssets = [];
                const monthlyOperatingCF = [];
                const monthlyInvestingCF = [];
                const monthlyFinancingCF = [];

                let currentCash = CONSTANTS.INITIAL_CASH;
                let currentDebt = 0;
                let currentInvestmentValue = 0;
                let currentExternalInvestment = 0;
                let currentCumulativeProfit = 0;

                const allTransactions = gameState.transactions;

                for (let turn = 1; turn < endTurn; turn++) {
                    const turnTransactions = allTransactions.filter(t => t.turn === turn);
                    
                    // 月次のPLとCFを計算
                    const monthlyPL = { totalRevenue: 0, totalExpense: 0 };
                    const monthlyCS = { operating: 0, investing: 0, financing: 0 };
                    
                    monthlyCS.financing += CONSTANTS.MONTHLY_SUPPORT;
                    
                    turnTransactions.forEach(t => {
                        switch(t.category) {
                            case 'business_income': monthlyPL.totalRevenue += t.amount; monthlyCS.operating += t.amount; break;
                            case 'misc_income': monthlyPL.totalRevenue += t.amount; monthlyCS.operating += t.amount; break;
                            
                            case 'business_cost': monthlyPL.totalExpense += t.amount; monthlyCS.operating -= t.amount; break;
                            case 'personnel_cost': monthlyPL.totalExpense += t.amount; monthlyCS.operating -= t.amount; break;
                            case 'retirement_cost': monthlyPL.totalExpense += t.amount; monthlyCS.operating -= t.amount; break;
                            case 'interest_expense': monthlyPL.totalExpense += t.amount; monthlyCS.operating -= t.amount; break;
                            case 'misc_expense': monthlyPL.totalExpense += t.amount; monthlyCS.operating -= t.amount; break;

                            case 'hypothesis_testing': monthlyPL.totalExpense += t.amount; monthlyCS.investing -= t.amount; break;
                            case 'business_construction': monthlyPL.totalExpense += t.amount; monthlyCS.investing -= t.amount; break;
                            
                            case 'external_investment': monthlyCS.financing += t.amount; break;
                            case 'borrow': monthlyCS.financing += t.amount; break;
                            case 'repay': monthlyCS.financing -= t.amount; break;
                        }
                    });
                    
                    const monthlyNetCF = monthlyCS.operating + monthlyCS.investing + monthlyCS.financing;
                    currentCash += monthlyNetCF;
                    currentCumulativeProfit += (monthlyPL.totalRevenue - monthlyPL.totalExpense);
                    
                    // 月末のBS項目を計算
                    currentDebt += (turnTransactions.filter(t => t.category === 'borrow').reduce((s, t) => s + t.amount, 0));
                    currentDebt -= (turnTransactions.filter(t => t.category === 'repay').reduce((s, t) => s + t.amount, 0));
                    
                    currentInvestmentValue += (turnTransactions.filter(t => t.category === 'hypothesis_testing' || t.category === 'business_construction').reduce((s, t) => s + t.amount, 0));
                    currentExternalInvestment += CONSTANTS.MONTHLY_SUPPORT + (turnTransactions.filter(t => t.category === 'external_investment').reduce((s, t) => s + t.amount, 0));
                    
                    const currentTotalAssets = currentCash + currentInvestmentValue;
                    
                    if (turn >= startTurn) {
                        const year = Math.floor((turn - 1) / 12) + 1;
                        const month = ((turn - 1) % 12) + 1;
                        labels.push(`${year}年${month}月`);
                        cumulativeProfit.push(currentCumulativeProfit);
                        cashBalance.push(currentCash);
                        totalAssets.push(currentTotalAssets);
                        monthlyOperatingCF.push(monthlyCS.operating);
                        monthlyInvestingCF.push(monthlyCS.investing);
                        monthlyFinancingCF.push(monthlyCS.financing);
                    }
                }
                
                return { labels, cumulativeProfit, cashBalance, totalAssets, monthlyOperatingCF, monthlyInvestingCF, monthlyFinancingCF };
            }


            // --- 計算ロジック (スナップショット) ---
            function calculateFinancials(period) {
                let startTurn = 1;
                let endTurn = gameState.currentTurn;
                
                if (period === 'lastTurn') {
                    startTurn = Math.max(1, gameState.currentTurn - 1);
                    endTurn = startTurn + 1;
                } else if (period === 'currentTurn') {
                    startTurn = gameState.currentTurn;
                    endTurn = startTurn + 1;
                } else if (period === 'currentYear') {
                    const currentYear = Math.floor((gameState.currentTurn - 1) / 12);
                    startTurn = currentYear * 12 + 1;
                }
                
                const relevantTransactions = gameState.transactions.filter(t => t.turn >= startTurn && t.turn < endTurn);
                
                const pl = {
                    businessIncome: 0, businessCost: 0, miscIncome: 0, personnelCost: 0, retirementCost: 0, 
                    hypothesisCost: 0, constructionCost: 0, interestExpense: 0, miscExpense: 0,
                };
                
                const cs = {
                    operating: { businessIncome: 0, businessCost: 0, miscIncome: 0, personnelCost: 0, retirementCost: 0, interestExpense: 0, miscExpense: 0 },
                    investing: { hypothesisCost: 0, constructionCost: 0 },
                    financing: { support: 0, externalInvestment: 0, borrowing: 0, repayment: 0 }
                };

                for (let i = startTurn; i < endTurn; i++) {
                    cs.financing.support += CONSTANTS.MONTHLY_SUPPORT;
                }
                
                relevantTransactions.forEach(t => {
                    switch(t.category) {
                        case 'business_income': pl.businessIncome += t.amount; cs.operating.businessIncome += t.amount; break;
                        case 'business_cost': pl.businessCost += t.amount; cs.operating.businessCost += t.amount; break;
                        case 'misc_income': pl.miscIncome += t.amount; cs.operating.miscIncome += t.amount; break;
                        case 'personnel_cost': pl.personnelCost += t.amount; cs.operating.personnelCost += t.amount; break;
                        case 'retirement_cost': pl.retirementCost += t.amount; cs.operating.retirementCost += t.amount; break;
                        case 'hypothesis_testing': pl.hypothesisCost += t.amount; cs.investing.hypothesisCost += t.amount; break;
                        case 'business_construction': pl.constructionCost += t.amount; cs.investing.constructionCost += t.amount; break;
                        case 'interest_expense': pl.interestExpense += t.amount; cs.operating.interestExpense += t.amount; break;
                        case 'misc_expense': pl.miscExpense += t.amount; cs.operating.miscExpense += t.amount; break;
                        case 'external_investment': cs.financing.externalInvestment += t.amount; break;
                        case 'borrow': cs.financing.borrowing += t.amount; break;
                        case 'repay': cs.financing.repayment += t.amount; break;
                    }
                });

                pl.totalRevenue = pl.businessIncome + pl.miscIncome;
                pl.totalExpense = pl.businessCost + pl.personnelCost + pl.retirementCost + pl.hypothesisCost + pl.constructionCost + pl.interestExpense + pl.miscExpense;
                pl.profit = pl.totalRevenue - pl.totalExpense;
                
                cs.operatingCF = cs.operating.businessIncome + cs.operating.miscIncome - (cs.operating.businessCost + cs.operating.personnelCost + cs.operating.retirementCost + cs.operating.interestExpense + cs.operating.miscExpense);
                cs.investingCF = -cs.investing.hypothesisCost - cs.investing.constructionCost;
                cs.financingCF = cs.financing.support + cs.financing.externalInvestment + cs.financing.borrowing - cs.financing.repayment;
                cs.netCashFlow = cs.operatingCF + cs.investingCF + cs.financingCF;
                
                // BSは常に「現在」のスナップショット (period === 'total' の場合と同じ)
                const allTransactions = gameState.transactions.filter(t => t.turn < gameState.currentTurn);
                const bs = { cash: gameState.cash, debt: gameState.debt };
                bs.investmentValue = allTransactions
                    .filter(t => t.category === 'hypothesis_testing' || t.category === 'business_construction')
                    .reduce((sum, t) => sum + t.amount, 0);
                bs.externalInvestment = (gameState.currentTurn - 1) * CONSTANTS.MONTHLY_SUPPORT + allTransactions
                    .filter(t => t.category === 'external_investment')
                    .reduce((sum, t) => sum + t.amount, 0);

                let totalRevenue_forBS = 0;
                let totalExpense_forBS = 0;
                allTransactions.forEach(t => {
                    switch(t.category) {
                        case 'business_income': case 'misc_income':
                            totalRevenue_forBS += t.amount; break;
                        case 'business_cost': case 'personnel_cost': case 'retirement_cost': case 'hypothesis_testing':
                        case 'business_construction': case 'interest_expense': case 'misc_expense':
                            totalExpense_forBS += t.amount; break;
                    }
                });
                bs.retainedEarnings = totalRevenue_forBS - totalExpense_forBS;
                bs.totalAssets = bs.cash + bs.investmentValue;
                bs.totalLiabilities = bs.debt;
                bs.totalNetAssets = bs.externalInvestment + bs.retainedEarnings;
                bs.totalLiabilitiesAndNetAssets = bs.totalLiabilities + bs.totalNetAssets;
                if (Math.abs(bs.totalAssets - bs.totalLiabilitiesAndNetAssets) < 0.01) {
                    bs.totalLiabilitiesAndNetAssets = bs.totalAssets;
                }

                return { pl, bs, cs };
            }

            // --- イベントハンドラ ---
            function handleNextTurn() {
                if (gameState.currentTurn > gameState.totalTurns) return;

                if (gameState.currentTurn === gameState.totalTurns) {
                    showResults();
                    gameState.currentTurn++; // ゲーム終了状態にする
                    saveGame();
                    return;
                }
                
                gameState.currentTurn++;

                // 支援金
                gameState.cash += CONSTANTS.MONTHLY_SUPPORT;
                
                // 事業からの収支
                const totalBusinessRevenue = gameState.businesses.reduce((sum, b) => sum + b.revenue, 0);
                const totalBusinessCost = gameState.businesses.reduce((sum, b) => sum + b.cost, 0);
                if (totalBusinessRevenue > 0) {
                    gameState.cash += totalBusinessRevenue;
                    addTransaction('income', 'business_income', totalBusinessRevenue, gameState.currentTurn -1);
                }
                if (totalBusinessCost > 0) {
                    gameState.cash -= totalBusinessCost;
                    addTransaction('expense', 'business_cost', totalBusinessCost, gameState.currentTurn -1);
                }

                // 人件費
                const personnelCost = gameState.employees.reduce((sum, e) => sum + e.cost, 0);
                if (personnelCost > 0) {
                    gameState.cash -= personnelCost;
                    addTransaction('expense', 'personnel_cost', personnelCost, gameState.currentTurn -1);
                }
                
                // 利息
                if (gameState.debt > 0) {
                    const monthlyInterestRate = gameState.interestRate / 12;
                    const interest = Math.round(gameState.debt * monthlyInterestRate);
                    gameState.cash -= interest;
                    addTransaction('expense', 'interest_expense', interest, gameState.currentTurn -1);
                }

                saveGame();
                renderAll();
            }
            
            function addTransaction(type, category, amount, turn) {
                 gameState.transactions.push({ turn, type, category, amount });
            }

            function handleTransactionSubmit(e) {
                e.preventDefault();
                const amount = parseInt(dom.transactionAmount.value);
                const { type, category } = uiState.transaction;

                if (!category) {
                    alert('カテゴリを選択してください。');
                    return;
                }
                if (isNaN(amount) || amount <= 0) {
                    alert('有効な金額を入力してください。');
                    return;
                }

                if (type === 'income') {
                    gameState.cash += amount;
                } else {
                    if (gameState.cash < amount) {
                        alert('現金が不足しています！');
                        return;
                    }
                    gameState.cash -= amount;
                }
                addTransaction(type, category, amount, gameState.currentTurn);

                saveGame();
                renderAll();
                closeModal(dom.transactionModal);
            }

            async function handleHireClick(e) {
                const target = e.target.closest('button');
                if (!target || !target.dataset.cost) return;
                
                const cost = parseInt(target.dataset.cost);
                const confirmed = await showConfirmation(
                    `人件費 ${cost}万円/月 の人材を新規に雇用しますか？`,
                    { yesText: 'はい、雇用します' }
                );
                if (confirmed) {
                    const newEmployee = { id: Date.now(), cost };
                    gameState.employees.push(newEmployee);
                    saveGame();
                    renderEmployeeList();
                }
            }
            
            async function handleFireEmployee(e) {
                if (!e.target.classList.contains('fire-btn')) return;
                const employeeId = parseInt(e.target.dataset.id);
                const employeeIndex = gameState.employees.findIndex(emp => emp.id === employeeId);
                if (employeeIndex === -1) return;

                const employee = gameState.employees[employeeIndex];
                const retirementCost = employee.cost * CONSTANTS.RETIREMENT_COST_MULTIPLIER;
                
                if (gameState.cash < retirementCost) {
                    alert(`退職金を支払うための現金が不足しています。（必要額: ${retirementCost}万円）`);
                    return;
                }
                
                const confirmed = await showConfirmation(
                    `人件費 ${employee.cost}万円/月の従業員を退職させますか？\n退職金として ${retirementCost}万円 が支出されます。`,
                    { danger: true }
                );
                if (confirmed) {
                    gameState.cash -= retirementCost;
                    addTransaction('expense', 'retirement_cost', retirementCost, gameState.currentTurn);
                    gameState.employees.splice(employeeIndex, 1);
                    saveGame();
                    renderAll();
                }
            }
            
            function handleDebtSubmit(e) {
                e.preventDefault();
                const action = uiState.debtAction;
                const amount = parseInt(dom.debtAmount.value);

                if (isNaN(amount) || amount <= 0) {
                    alert('有効な金額を入力してください。');
                    return;
                }

                if (action === 'borrow') {
                    gameState.debt += amount;
                    gameState.cash += amount;
                    addTransaction('income', 'borrow', amount, gameState.currentTurn);
                } else {
                    if (amount > gameState.debt) {
                        alert('借入残高を超える返済はできません。');
                        return;
                    }
                    if (amount > gameState.cash) {
                        alert('返済するための現金が不足しています。');
                        return;
                    }
                    gameState.debt -= amount;
                    gameState.cash -= amount;
                    addTransaction('expense', 'repay', amount, gameState.currentTurn);
                }
                saveGame();
                renderAll();
                closeModal(dom.debtModal);
            }

            function handleSettingsSubmit(e) {
                e.preventDefault();
                const newRate = parseFloat(dom.interestRateInput.value);
                const gameLengthYears = parseInt(dom.gameLengthInput.value);

                if (isNaN(newRate) || newRate < 0) {
                    alert('有効な金利をパーセントで入力してください。');
                    return;
                }
                if (isNaN(gameLengthYears) || gameLengthYears < 1 || gameLengthYears > 5) {
                    alert('ゲームの長さは1〜5年の間で設定してください。');
                    return;
                }

                gameState.interestRate = newRate / 100;
                gameState.totalTurns = gameLengthYears * 12;
                saveGame();
                renderAll();
                closeModal(dom.settingsModal);
            }

            function handleBusinessSubmit(e) {
                e.preventDefault();
                const name = dom.businessForm.querySelector('#business-name').value.trim();
                const revenue = parseInt(dom.businessForm.querySelector('#business-revenue').value);
                const cost = parseInt(dom.businessForm.querySelector('#business-cost').value);

                if (!name) {
                    alert('事業名を入力してください。');
                    return;
                }
                if (isNaN(revenue) || revenue < 0 || isNaN(cost) || cost < 0) {
                    alert('有効な売上と費用を万円単位で入力してください。');
                    return;
                }

                gameState.businesses.push({ id: Date.now(), name, revenue, cost });
                saveGame();
                renderBusinessList();
                dom.businessForm.reset();
            }

            async function handleDeleteBusiness(e) {
                if (!e.target.classList.contains('delete-business-btn')) return;
                const businessId = parseInt(e.target.dataset.id);
                const confirmed = await showConfirmation(
                    'この事業を削除しますか？この操作は元に戻せません。', 
                    { danger: true }
                );
                if (confirmed) {
                    gameState.businesses = gameState.businesses.filter(b => b.id !== businessId);
                    saveGame();
                    renderBusinessList();
                }
            }

            // --- ★修正: リザルト表示 ---
            function showResults() {
                finalFinancials = calculateFinancials('total');
                const { pl, bs, cs } = finalFinancials;
                const finalProfit = bs.retainedEarnings;
                
                const businessBonus = gameState.businesses.reduce((sum, biz) => {
                    const monthlyProfit = biz.revenue - biz.cost;
                    return sum + (monthlyProfit * 36);
                }, 0);

                const totalScore = finalProfit + businessBonus;

                const formatYen = (val) => `${val.toLocaleString()}万円`;

                dom.resultProfit.textContent = formatYen(finalProfit);
                dom.resultBonus.textContent = `+ ${formatYen(businessBonus)}`;
                dom.resultTotalScore.textContent = formatYen(totalScore);

                // デフォルトで最終PLのグラフとテーブルを表示
                if (chartInstances.result) chartInstances.result.destroy();
                dom.resultReportTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                
                dom.resultReportTabs.querySelector('[data-tab="pl"]').classList.add('active');
                
                const ctx = dom.resultChart.getContext('2d');
                chartInstances.result = createPLChart(ctx, pl); // リザルトはスナップショットでOK
                dom.resultReportContent.innerHTML = generatePLHtml(pl);

                openModal(dom.resultsModal);
            }

            // --- モーダル制御 & UI更新 ---
            function openModal(modal) {
                modal.classList.remove('hidden');
            }
            function closeModal(modal) {
                modal.classList.add('hidden');
                if (modal.querySelector('form')) {
                    modal.querySelector('form').reset();
                }
            }

            function showConfirmation(message, options = {}) {
                const {
                    yesText = 'はい',
                    noText = 'いいえ',
                    danger = false
                } = options;

                dom.confirmMessage.textContent = message;
                dom.confirmYesBtn.textContent = yesText;
                dom.confirmNoBtn.textContent = noText;

                dom.confirmYesBtn.classList.toggle('btn-danger', danger);
                dom.confirmYesBtn.classList.toggle('btn-primary', !danger);

                openModal(dom.confirmModal);

                return new Promise((resolve) => {
                    const yesHandler = () => {
                        cleanup();
                        resolve(true);
                    };
                    const noHandler = () => {
                        cleanup();
                        resolve(false);
                    };
                    const cleanup = () => {
                        dom.confirmYesBtn.removeEventListener('click', yesHandler);
                        dom.confirmNoBtn.removeEventListener('click', noHandler);
                        closeModal(dom.confirmModal);
                    };

                    dom.confirmYesBtn.addEventListener('click', yesHandler, { once: true });
                    dom.confirmNoBtn.addEventListener('click', noHandler, { once: true });
                });
            }
            
            function setupTransactionModalUI() {
                const { type } = uiState.transaction;
                
                dom.transactionTypeSelector.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
                
                dom.transactionCategorySelector.innerHTML = '';
                CATEGORIES[type].forEach(cat => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.category = cat.value;
                    button.textContent = cat.text;
                    button.className = 'btn';
                    dom.transactionCategorySelector.appendChild(button);
                });
                uiState.transaction.category = '';
            }
            
            function updatePeriodSelectorUI() {
                dom.periodSelector.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.period === uiState.reportPeriod);
                });
            }

            // --- イベントリスナーの設定 ---
            document.getElementById('next-turn-btn').addEventListener('click', handleNextTurn);
            document.getElementById('reset-game-btn').addEventListener('click', resetGame);
            
            document.getElementById('settings-btn').addEventListener('click', () => {
                dom.interestRateInput.value = (gameState.interestRate * 100).toFixed(1);
                dom.gameLengthInput.value = gameState.totalTurns / 12;
                openModal(dom.settingsModal);
            });
            
            document.getElementById('add-transaction-btn').addEventListener('click', () => {
                uiState.transaction.type = 'expense';
                setupTransactionModalUI();
                openModal(dom.transactionModal);
            });
            document.getElementById('manage-employees-btn').addEventListener('click', () => openModal(dom.employeesModal));
            document.getElementById('manage-debt-btn').addEventListener('click', () => {
                dom.currentDebt.textContent = `${gameState.debt.toLocaleString()}万円`;
                uiState.debtAction = 'borrow';
                // ★修正: ここを uiState.debtAction で比較する
                dom.debtActionSelector.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.action === uiState.debtAction);
                });
                openModal(dom.debtModal);
            });

            document.getElementById('manage-business-btn').addEventListener('click', () => openModal(dom.businessModal));
            dom.businessForm.addEventListener('submit', handleBusinessSubmit);
            document.getElementById('close-business-modal').addEventListener('click', () => closeModal(dom.businessModal));
            dom.businessList.addEventListener('click', handleDeleteBusiness);


            dom.transactionForm.addEventListener('submit', handleTransactionSubmit);
            document.getElementById('cancel-transaction').addEventListener('click', () => closeModal(dom.transactionModal));
            dom.transactionTypeSelector.addEventListener('click', (e) => {
                const type = e.target.closest('button')?.dataset.type;
                if (type) {
                    uiState.transaction.type = type;
                    setupTransactionModalUI();
                }
            });
            dom.transactionCategorySelector.addEventListener('click', (e) => {
                const category = e.target.closest('button')?.dataset.category;
                if (category) {
                    uiState.transaction.category = category;
                    dom.transactionCategorySelector.querySelectorAll('button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.category === category);
                    });
                }
            });

            dom.hireOptions.addEventListener('click', handleHireClick);
            document.getElementById('close-employees-modal').addEventListener('click', () => closeModal(dom.employeesModal));
            dom.employeeList.addEventListener('click', handleFireEmployee);
            
            dom.debtForm.addEventListener('submit', handleDebtSubmit);
            document.getElementById('cancel-debt').addEventListener('click', () => closeModal(dom.debtModal));
            dom.debtActionSelector.addEventListener('click', (e) => {
                const action = e.target.closest('button')?.dataset.action;
                if (action) {
                    uiState.debtAction = action;
                    dom.debtActionSelector.querySelectorAll('button').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.action === action);
                    });
                }
            });
            
            dom.settingsForm.addEventListener('submit', handleSettingsSubmit);
            document.getElementById('cancel-settings').addEventListener('click', () => closeModal(dom.settingsModal));


            dom.reportTabs.addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON') return;
                dom.reportTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                renderReport();
            });
            dom.periodSelector.addEventListener('click', e => {
                const period = e.target.closest('button')?.dataset.period;
                if (period) {
                    uiState.reportPeriod = period;
                    updatePeriodSelectorUI();
                    renderReport();
                }
            });

            // ★修正: リザルト画面のタブ切り替えリスナー
            dom.resultReportTabs.addEventListener('click', e => {
                if (e.target.tagName !== 'BUTTON' || !finalFinancials) return;
                
                dom.resultReportTabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                const activeTab = e.target.dataset.tab;
                const { pl, bs, cs } = finalFinancials;
                let html = '';

                if (chartInstances.result) {
                    chartInstances.result.destroy();
                    chartInstances.result = null;
                }
                const ctx = dom.resultChart.getContext('2d');

                if (activeTab === 'pl') {
                    chartInstances.result = createPLChart(ctx, pl);
                    html = generatePLHtml(pl);
                } else if (activeTab === 'bs') {
                    chartInstances.result = createBSChart(ctx, bs);
                    html = generateBSHtml(bs);
                } else if (activeTab === 'cs') {
                    chartInstances.result = createCSChart(ctx, cs);
                    html = generateCSHtml(cs);
                }
                dom.resultReportContent.innerHTML = html;
            });
            
            document.getElementById('new-game-btn').addEventListener('click', () => {
                closeModal(dom.resultsModal);
                resetGame();
            });


            // --- 初期化処理の実行 ---
            initGame();
        });
    </script>
</body>
</html>

